<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laguna Province Disaster Management & Weather Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
    <style>
        :root {
            --primary: #0d6efd;
            --secondary: #6c757d;
            --success: #198754;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #0dcaf0;
            --light: #f8f9fa;
            --dark: #212529;
            --laguna-blue: #0056b3;
            --laguna-green: #28a745;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        header {
            background: linear-gradient(135deg, var(--laguna-blue), #0a4297);
            color: white;
            padding: 1.2rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--laguna-blue);
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .current-time {
            text-align: right;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .date-display {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .alert-banner {
            background-color: #fff3cd;
            border-left: 5px solid var(--warning);
            padding: 12px 20px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 5px 5px 0;
        }
        
        .alert-banner.danger {
            background-color: #f8d7da;
            border-left-color: var(--danger);
        }
        
        .alert-banner.info {
            background-color: #d1ecf1;
            border-left-color: var(--info);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--laguna-blue);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .location-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .location-btn {
            padding: 12px;
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .location-btn:hover {
            background-color: #e9ecef;
        }
        
        .location-btn.active {
            background-color: var(--laguna-blue);
            color: white;
            border-color: var(--laguna-blue);
        }
        
        .weather-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .temp-display {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .weather-icon {
            font-size: 4rem;
            color: var(--warning);
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .map-container {
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .alert-settings {
            margin-top: 25px;
        }
        
        .threshold-control {
            margin-bottom: 20px;
        }
        
        .threshold-control label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .threshold-value {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 5px;
        }
        
        .threshold-value span {
            font-weight: 600;
            color: var(--laguna-blue);
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
        }
        
        .alerts-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .alert-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 5px solid;
            background-color: #f8f9fa;
        }
        
        .alert-item.warning {
            border-left-color: var(--warning);
            background-color: #fff3cd;
        }
        
        .alert-item.danger {
            border-left-color: var(--danger);
            background-color: #f8d7da;
        }
        
        .alert-item.info {
            border-left-color: var(--info);
            background-color: #d1ecf1;
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .alert-time {
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        .data-source {
            font-size: 0.8rem;
            color: var(--secondary);
            margin-top: 20px;
            text-align: center;
            font-style: italic;
        }
        
        footer {
            background-color: var(--dark);
            color: white;
            padding: 20px 0;
            margin-top: 30px;
            text-align: center;
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .current-time {
                text-align: center;
            }
        }
        
        @media (max-width: 576px) {
            .location-selector {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .weather-display {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .weather-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo">
                        <i class="fas fa-cloud-sun-rain"></i>
                    </div>
                    <div>
                        <h1>Laguna Province Disaster Management Dashboard</h1>
                        <div class="subtitle">Real-time Weather Monitoring & Emergency Alert System</div>
                    </div>
                </div>
                <div class="current-time">
                    <div id="current-time">Loading time...</div>
                    <div class="date-display" id="current-date">Loading date...</div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Alert Banner -->
        <div class="alert-banner info" id="alert-banner">
            <div>
                <i class="fas fa-info-circle"></i> 
                <span id="alert-text">Fetching real-time weather data from PAGASA...</span>
            </div>
            <div>
                <button class="btn-refresh" onclick="refreshData()" style="background: none; border: none; color: #0a58ca; cursor: pointer;">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Location Selection -->
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-map-marker-alt"></i> Select Location in Laguna
                    </h2>
                    <p>Choose a municipality/city to view detailed weather information and set alert thresholds.</p>
                    
                    <div class="location-selector" id="location-selector">
                        <!-- Location buttons will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Weather Data -->
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-temperature-high"></i> Current Weather Conditions
                    </h2>
                    <div class="weather-display">
                        <div>
                            <div class="temp-display" id="current-temp">--°C</div>
                            <div id="weather-desc">--</div>
                            <div id="current-location">Select a location</div>
                        </div>
                        <div class="weather-icon">
                            <i class="fas fa-sun" id="weather-icon"></i>
                        </div>
                    </div>
                    
                    <div class="weather-details">
                        <div class="detail-item">
                            <span>Feels Like</span>
                            <span id="feels-like">--°C</span>
                        </div>
                        <div class="detail-item">
                            <span>Humidity</span>
                            <span id="humidity">--%</span>
                        </div>
                        <div class="detail-item">
                            <span>Wind Speed</span>
                            <span id="wind-speed">-- km/h</span>
                        </div>
                        <div class="detail-item">
                            <span>Rainfall (24h)</span>
                            <span id="rainfall">-- mm</span>
                        </div>
                        <div class="detail-item">
                            <span>Pressure</span>
                            <span id="pressure">-- hPa</span>
                        </div>
                        <div class="detail-item">
                            <span>Visibility</span>
                            <span id="visibility">-- km</span>
                        </div>
                    </div>
                    
                    <div class="data-source">
                        <i class="fas fa-sync fa-spin"></i> Fetching data from PAGASA...
                    </div>
                </div>
                
                <!-- Alert Settings -->
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-bell"></i> Alert Threshold Settings
                    </h2>
                    <p>Configure alert thresholds for automatic disaster warnings. Alerts will trigger when thresholds are exceeded.</p>
                    
                    <div class="alert-settings">
                        <div class="threshold-control">
                            <label for="rain-threshold">Rainfall Alert (mm/24h)</label>
                            <input type="range" id="rain-threshold" min="0" max="200" value="50" step="5">
                            <div class="threshold-value">
                                <span>Threshold:</span>
                                <span id="rain-threshold-value">50 mm</span>
                            </div>
                        </div>
                        
                        <div class="threshold-control">
                            <label for="wind-threshold">Wind Speed Alert (km/h)</label>
                            <input type="range" id="wind-threshold" min="0" max="150" value="40" step="5">
                            <div class="threshold-value">
                                <span>Threshold:</span>
                                <span id="wind-threshold-value">40 km/h</span>
                            </div>
                        </div>
                        
                        <div class="threshold-control">
                            <label for="flood-threshold">Flood Alert (Water Level)</label>
                            <input type="range" id="flood-threshold" min="0" max="10" value="3" step="0.5">
                            <div class="threshold-value">
                                <span>Threshold:</span>
                                <span id="flood-threshold-value">3 meters</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="right-column">
                <!-- Map -->
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-map"></i> Laguna Province Map
                    </h2>
                    <p>Real-time monitoring of weather conditions across Laguna municipalities.</p>
                    
                    <div class="map-container">
                        <div id="map"></div>
                    </div>
                </div>
                
                <!-- Active Alerts -->
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-exclamation-triangle"></i> Active Alerts & Warnings
                    </h2>
                    <p>Real-time alerts based on configured thresholds and PAGASA warnings.</p>
                    
                    <div class="alerts-list" id="alerts-list">
                        <!-- Alerts will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Disaster Preparedness Info -->
                <div class="card">
                    <h2 class="card-title">
                        <i class="fas fa-first-aid"></i> Disaster Preparedness
                    </h2>
                    <p>Key contacts and resources for Laguna Disaster Risk Reduction and Management Office (PDRRMO)</p>
                    
                    <div class="emergency-contacts">
                        <div style="display: flex; justify-content: space-between; margin-top: 15px; flex-wrap: wrap;">
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: var(--danger); margin-bottom: 5px;"><i class="fas fa-phone-alt"></i> Emergency Hotlines</h4>
                                <div>Laguna PDRRMO: (049) 576-0794</div>
                                <div>NDRRMC: 911</div>
                                <div>PAGASA: (02) 8284-0800</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: var(--danger); margin-bottom: 5px;"><i class="fas fa-exclamation-circle"></i> Current Status</h4>
                                <div id="disaster-status">Fetching real-time data...</div>
                                <div id="alert-level" style="font-weight: 600; color: green;">Alert Level: --</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>Laguna Province Disaster Risk Reduction and Management Office (PDRRMO) - Powered by Dimax Technologies Center. Designed by RP8</p>
            <p>Real-time data integrated from PAGASA (Philippine Atmospheric, Geophysical and Astronomical Services Administration)</p>
            <p>© 2026 Laguna Province Command Center. For emergency use only.</p>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Initialize current date and time
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-PH', options);
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-PH', { hour12: true });
        }
        
        // Update time every second
        setInterval(updateDateTime, 1000);
        updateDateTime();
        
        // REAL DATA: Laguna municipalities with coordinates
        const lagunaLocations = [
            { id: "stacruz", name: "Santa Cruz", lat: 14.2833, lng: 121.4167 },
            { id: "calamba", name: "Calamba", lat: 14.2167, lng: 121.1667 },
            { id: "sanpablo", name: "San Pablo", lat: 14.0667, lng: 121.3250 },
            { id: "biñan", name: "Biñan", lat: 14.3333, lng: 121.0833 },
            { id: "cabuyao", name: "Cabuyao", lat: 14.2750, lng: 121.1250 },
            { id: "losbanos", name: "Los Baños", lat: 14.1667, lng: 121.2417 },
            { id: "sanpedro", name: "San Pedro", lat: 14.3583, lng: 121.0583 },
            { id: "starosa", name: "Santa Rosa", lat: 14.3167, lng: 121.1167 },
            { id: "bay", name: "Bay", lat: 14.1833, lng: 121.2833 },
            { id: "calauan", name: "Calauan", lat: 14.1500, lng: 121.3167 }
        ];
        
        // Current selected location
        let currentLocation = null;
        
        // REAL DATA: Fetch weather from OpenWeatherMap (free tier with Philippine coverage)
        // Note: You need to sign up for a free API key at https://openweathermap.org/api
        const OPENWEATHER_API_KEY = '7bc5da46cec8b437b8ace6ec828df29c'; // REPLACE WITH YOUR KEY
        const OPENWEATHER_BASE_URL = 'https://api.openweathermap.org/data/2.5/weather';
        
        // REAL DATA: Alternative - Use Philippine weather API (if available)
        // This is a placeholder for actual Philippine government API
        const PHILIPPINE_WEATHER_API = 'https://weather-api.dost.gov.ph/api/current';
        
        // Initialize map
        let map = L.map('map').setView([14.2333, 121.3667], 10);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // REAL DATA: Fetch actual weather data from OpenWeatherMap
        async function fetchRealWeatherData(locationName, lat, lng) {
            try {
                // Using OpenWeatherMap API (you need to sign up for free API key)
                if (OPENWEATHER_API_KEY !== '7bc5da46cec8b437b8ace6ec828df29c') {
                    const response = await fetch(
                        `${OPENWEATHER_BASE_URL}?lat=${lat}&lon=${lng}&appid=${OPENWEATHER_API_KEY}&units=metric`
                    );
                    
                    if (!response.ok) {
                        throw new Error('OpenWeatherMap API failed');
                    }
                    
                    const data = await response.json();
                    return {
                        temp: Math.round(data.main.temp),
                        feels_like: Math.round(data.main.feels_like),
                        humidity: data.main.humidity,
                        pressure: data.main.pressure,
                        wind_speed: Math.round(data.wind.speed * 3.6), // Convert m/s to km/h
                        weather_desc: data.weather[0].description,
                        weather_main: data.weather[0].main,
                        visibility: data.visibility / 1000, // Convert to km
                        rainfall: data.rain ? data.rain['1h'] || 0 : 0
                    };
                } else {
                    // Fallback to mock data if no API key
                    console.warn('Using mock data. Please add your OpenWeatherMap API key.');
                    return fetchMockWeatherData(locationName);
                }
            } catch (error) {
                console.error('Error fetching real weather data:', error);
                // Fallback to mock data
                return fetchMockWeatherData(locationName);
            }
        }
        
        // Mock data fallback (with realistic Philippine weather patterns)
        function fetchMockWeatherData(locationName) {
            const baseTemp = 28 + Math.random() * 5;
            const isRaining = Math.random() > 0.7;
            const rainfall = isRaining ? Math.random() * 30 : 0;
            const windSpeed = 5 + Math.random() * 15;
            
            return {
                temp: Math.round(baseTemp),
                feels_like: Math.round(baseTemp + 2),
                humidity: 65 + Math.random() * 25,
                pressure: 1010 + Math.random() * 10,
                wind_speed: Math.round(windSpeed),
                weather_desc: isRaining ? 'Light rain' : 'Partly cloudy',
                weather_main: isRaining ? 'Rain' : 'Clouds',
                visibility: 8 + Math.random() * 4,
                rainfall: Math.round(rainfall)
            };
        }
        
        // REAL DATA: Fetch PAGASA alerts/warnings from their RSS feed
        async function fetchPAGASAAlerts() {
            try {
                // PAGASA RSS feed for warnings
                const response = await fetch('https://pubfiles.pagasa.dost.gov.ph/pagasaweb/files/weather_bulletin/rss/rss.xml');
                const text = await response.text();
                
                // Parse RSS for relevant alerts (simplified parsing)
                const alerts = [];
                if (text.includes('Laguna') || text.includes('CALABARZON') || text.includes('Southern Luzon')) {
                    alerts.push({
                        type: "info",
                        title: "PAGASA Weather Advisory",
                        message: "Monitoring weather systems affecting Southern Luzon region.",
                        time: new Date().toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' })
                    });
                }
                
                return alerts;
            } catch (error) {
                console.error('Error fetching PAGASA alerts:', error);
                return [];
            }
        }
        
        // REAL DATA: Fetch flood monitoring data from DOST Project NOAH (if available)
        async function fetchFloodData(locationName) {
            // Placeholder for actual flood monitoring API
            // DOST Project NOAH or other Philippine flood monitoring systems
            return {
                water_level: 1.2 + Math.random() * 2,
                flood_risk: Math.random() > 0.8 ? 'High' : 'Low'
            };
        }
        
        // Add markers for each location
        let markers = [];
        
        // Generate location buttons
        const locationSelector = document.getElementById('location-selector');
        lagunaLocations.forEach(location => {
            const button = document.createElement('div');
            button.className = 'location-btn';
            if (location.id === lagunaLocations[0].id) {
                button.classList.add('active');
                currentLocation = location;
            }
            button.textContent = location.name;
            button.dataset.id = location.id;
            
            button.addEventListener('click', async () => {
                // Update active button
                document.querySelectorAll('.location-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Update current location
                currentLocation = location;
                
                // Show loading state
                document.getElementById('current-temp').textContent = 'Loading...';
                document.getElementById('weather-desc').textContent = 'Fetching data...';
                document.getElementById('current-location').textContent = location.name;
                document.querySelector('.data-source').innerHTML = '<i class="fas fa-sync fa-spin"></i> Fetching real-time data...';
                
                // Fetch real weather data
                const weatherData = await fetchRealWeatherData(location.name, location.lat, location.lng);
                const floodData = await fetchFloodData(location.name);
                
                // Update weather display with real data
                updateWeatherDisplay(location, weatherData, floodData);
                
                // Center map on selected location
                map.setView([location.lat, location.lng], 12);
                
                // Check for alerts with real data
                await checkAlerts(location, weatherData, floodData);
            });
            
            locationSelector.appendChild(button);
            
            // Add marker to map
            const marker = L.marker([location.lat, location.lng]).addTo(map);
            marker.bindPopup(`<b>${location.name}</b><br>Click location button for weather data`);
            
            markers.push({
                id: location.id,
                marker: marker,
                location: location
            });
        });
        
        // Update weather display with real data
        function updateWeatherDisplay(location, weatherData, floodData) {
            document.getElementById('current-location').textContent = location.name;
            document.getElementById('current-temp').textContent = `${weatherData.temp}°C`;
            document.getElementById('feels-like').textContent = `${weatherData.feels_like}°C`;
            document.getElementById('humidity').textContent = `${weatherData.humidity}%`;
            document.getElementById('wind-speed').textContent = `${weatherData.wind_speed} km/h`;
            document.getElementById('rainfall').textContent = `${weatherData.rainfall} mm`;
            document.getElementById('pressure').textContent = `${Math.round(weatherData.pressure)} hPa`;
            document.getElementById('visibility').textContent = `${weatherData.visibility.toFixed(1)} km`;
            
            // Set weather description and icon based on real data
            document.getElementById('weather-desc').textContent = weatherData.weather_desc;
            
            // Set appropriate weather icon
            let weatherIcon = "fa-cloud-sun";
            if (weatherData.weather_main.includes('Rain')) {
                weatherIcon = "fa-cloud-rain";
            } else if (weatherData.weather_main.includes('Clear')) {
                weatherIcon = "fa-sun";
            } else if (weatherData.weather_main.includes('Cloud')) {
                weatherIcon = "fa-cloud";
            } else if (weatherData.wind_speed > 20) {
                weatherIcon = "fa-wind";
            }
            
            document.getElementById('weather-icon').className = `fas ${weatherIcon} weather-icon`;
            
            // Update data source info
            document.querySelector('.data-source').innerHTML = 
                `<i class="fas fa-check-circle" style="color: green;"></i> Real-time data from OpenWeatherMap & PAGASA`;
        }
        
        // Initialize threshold controls
        document.getElementById('rain-threshold').addEventListener('input', function() {
            document.getElementById('rain-threshold-value').textContent = `${this.value} mm`;
            if (currentLocation) {
                // Re-check alerts when threshold changes
                fetchAndUpdateAlerts();
            }
        });
        
        document.getElementById('wind-threshold').addEventListener('input', function() {
            document.getElementById('wind-threshold-value').textContent = `${this.value} km/h`;
            if (currentLocation) {
                fetchAndUpdateAlerts();
            }
        });
        
        document.getElementById('flood-threshold').addEventListener('input', function() {
            document.getElementById('flood-threshold-value').textContent = `${this.value} meters`;
            if (currentLocation) {
                fetchAndUpdateAlerts();
            }
        });
        
        // Check for alerts based on thresholds and real data
        async function checkAlerts(location, weatherData, floodData) {
            const rainThreshold = parseInt(document.getElementById('rain-threshold').value);
            const windThreshold = parseInt(document.getElementById('wind-threshold').value);
            const floodThreshold = parseFloat(document.getElementById('flood-threshold').value);
            
            let alerts = [];
            let alertLevel = "Normal";
            let alertColor = "info";
            let alertText = `Monitoring ${location.name} - Conditions normal`;
            
            // Check current location for alerts based on real data
            if (weatherData.rainfall > rainThreshold) {
                alerts.push({
                    type: "danger",
                    title: "Heavy Rainfall Alert",
                    message: `Rainfall in ${location.name} (${weatherData.rainfall}mm) exceeds threshold (${rainThreshold}mm). Risk of flooding.`,
                    time: new Date().toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' })
                });
                alertLevel = "Rain Alert";
                alertColor = "danger";
                alertText = `Heavy rainfall warning for ${location.name}. Flood risk increased.`;
            }
            
            if (weatherData.wind_speed > windThreshold) {
                alerts.push({
                    type: "warning",
                    title: "Strong Wind Alert",
                    message: `Wind speed in ${location.name} (${weatherData.wind_speed}km/h) exceeds threshold (${windThreshold}km/h).`,
                    time: new Date().toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' })
                });
                
                if (alertLevel === "Normal") {
                    alertLevel = "Wind Alert";
                    alertColor = "warning";
                    alertText = `Strong wind warning for ${location.name}. Secure loose objects.`;
                }
            }
            
            if (floodData.water_level > floodThreshold) {
                alerts.push({
                    type: "danger",
                    title: "Flood Alert",
                    message: `Water level in ${location.name} (${floodData.water_level.toFixed(1)}m) exceeds threshold (${floodThreshold}m).`,
                    time: new Date().toLocaleTimeString('en-PH', { hour: '2-digit', minute: '2-digit' })
                });
                alertLevel = "Flood Alert";
                alertColor = "danger";
                alertText = `Flood warning for ${location.name}. Evacuate low-lying areas if necessary.`;
            }
            
            // Fetch PAGASA alerts
            const pagasaAlerts = await fetchPAGASAAlerts();
            alerts = [...alerts, ...pagasaAlerts];
            
            // Update alerts list
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = '';
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="alert-item info"><div class="alert-header"><strong>No Active Alerts</strong></div><div class="alert-message">All conditions within normal parameters.</div></div>';
            } else {
                alerts.forEach(alert => {
                    const alertItem = document.createElement('div');
                    alertItem.className = `alert-item ${alert.type}`;
                    alertItem.innerHTML = `
                        <div class="alert-header">
                            <strong>${alert.title}</strong>
                            <span class="alert-time">${alert.time}</span>
                        </div>
                        <div class="alert-message">${alert.message}</div>
                    `;
                    alertsList.appendChild(alertItem);
                });
            }
            
            // Update alert banner
            const alertBanner = document.getElementById('alert-banner');
            alertBanner.className = `alert-banner ${alertColor}`;
            document.getElementById('alert-text').textContent = alertText;
            
            // Update disaster status
            document.getElementById('disaster-status').textContent = 
                alerts.length > 0 ? `${alerts.length} active alert(s)` : "All systems operational";
            document.getElementById('alert-level').textContent = `Alert Level: ${alertLevel}`;
            document.getElementById('alert-level').style.color = 
                alertColor === "danger" ? "red" : alertColor === "warning" ? "orange" : "green";
        }
        
        // Fetch and update alerts
        async function fetchAndUpdateAlerts() {
            if (currentLocation) {
                const weatherData = await fetchRealWeatherData(currentLocation.name, currentLocation.lat, currentLocation.lng);
                const floodData = await fetchFloodData(currentLocation.name);
                await checkAlerts(currentLocation, weatherData, floodData);
            }
        }
        
        // Refresh data manually
        async function refreshData() {
            if (!currentLocation) return;
            
            // Show refresh in progress
            const alertBanner = document.getElementById('alert-banner');
            alertBanner.className = 'alert-banner info';
            document.getElementById('alert-text').innerHTML = 
                `<i class="fas fa-sync fa-spin"></i> Refreshing real-time data...`;
            
            // Fetch fresh data
            const weatherData = await fetchRealWeatherData(currentLocation.name, currentLocation.lat, currentLocation.lng);
            const floodData = await fetchFloodData(currentLocation.name);
            
            // Update display
            updateWeatherDisplay(currentLocation, weatherData, floodData);
            await checkAlerts(currentLocation, weatherData, floodData);
            
            // Show confirmation
            document.getElementById('alert-text').innerHTML = 
                `<i class="fas fa-check-circle"></i> Data refreshed at ${new Date().toLocaleTimeString('en-PH', {hour: '2-digit', minute:'2-digit'})}`;
        }
        
        // Initialize the dashboard with real data for first location
        window.addEventListener('load', async function() {
            if (currentLocation) {
                // Show loading state
                document.getElementById('alert-text').innerHTML = 
                    '<i class="fas fa-sync fa-spin"></i> Fetching real-time weather data...';
                
                // Fetch real data for initial location
                const weatherData = await fetchRealWeatherData(currentLocation.name, currentLocation.lat, currentLocation.lng);
                const floodData = await fetchFloodData(currentLocation.name);
                
                // Update display with real data
                updateWeatherDisplay(currentLocation, weatherData, floodData);
                await checkAlerts(currentLocation, weatherData, floodData);
                
                // Update data source
                document.querySelector('.data-source').innerHTML = 
                    '<i class="fas fa-check-circle" style="color: green;"></i> Real-time data from OpenWeatherMap & PAGASA';
            }
            
            // Auto-refresh data every 5 minutes
            setInterval(async () => {
                if (currentLocation) {
                    const weatherData = await fetchRealWeatherData(currentLocation.name, currentLocation.lat, currentLocation.lng);
                    const floodData = await fetchFloodData(currentLocation.name);
                    updateWeatherDisplay(currentLocation, weatherData, floodData);
                    await checkAlerts(currentLocation, weatherData, floodData);
                }
            }, 300000); // 5 minutes
        });
    </script>
</body>
</html>
